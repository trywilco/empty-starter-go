version: "3.8"

services:
  go-dev:
    image: mcr.microsoft.com/devcontainers/go:1.21
    container_name: go-quiz-dev
    volumes:
      - ../..:/workspace:cached
      - go-modules:/go/pkg/mod
    working_dir: /workspace
    ports:
      - "8080:8080"
      - "2222:22"
    depends_on:
      - wilco-agent
      - postgres
    command: bash -c "apt-get update && apt-get install -y openssh-server && mkdir -p /var/run/sshd && echo 'root:password' | chpasswd && echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config && service ssh start && sleep infinity"
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=quiz_user
      - DB_PASSWORD=quiz_password
      - DB_NAME=quiz_db

  wilco-agent:
    image: public.ecr.aws/v0a2l7y2/wilco/anythink-devcontainer:latest
    container_name: wilco-agent
    ports:
      - "3009:3009"
      - "2223:22"
    volumes:
      - ../..:/workspace:cached
    working_dir: /workspace
    command: bash -c "apt-get update && apt-get install -y openssh-server && mkdir -p /var/run/sshd && echo 'root:password' | chpasswd && echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config && service ssh start && cd /wilco-agent && node agent.js 2>&1 | tee /workspace/wilco-agent.log &"
    environment:
      - ENGINE_BASE_URL=${ENGINE_BASE_URL}
      - GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN=${GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN}
      - CODESPACE_NAME=${CODESPACE_NAME}

  postgres:
    image: postgres:15-alpine
    container_name: quiz-api-postgres
    environment:
      POSTGRES_USER: quiz_user
      POSTGRES_PASSWORD: quiz_password
      POSTGRES_DB: quiz_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U quiz_user -d quiz_db" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  go-modules:
